{"version":3,"sources":["../src/prepare.ts"],"names":["prepareManifest","manifestPath","version","logger","manifest","spaces","log","zipFolder","asset","distFolder","zipPath","output","archive","zlib","level","pipe","directory","finalize","prepare","nextRelease","SemanticReleaseError","normalizedDistFolder"],"mappings":";;;;;AAAA;;AACA;;AACA;;AAEA;;AACA;;;;;;AAKA,MAAMA,eAAe,GAAG,CACtBC,YADsB,EAEtBC,OAFsB,EAGtBC,MAHsB,KAInB;AACH,QAAMC,QAAQ,GAAG,2BAAaH,YAAb,CAAjB;AAEA,8BAAcA,YAAd,eAAiCG,QAAjC;AAA2CF,IAAAA;AAA3C,MAAsD;AAAEG,IAAAA,MAAM,EAAE;AAAV,GAAtD;AAEAF,EAAAA,MAAM,CAACG,GAAP,CAAW,wBAAX,EAAqCJ,OAArC,EAA8CD,YAA9C;AACD,CAVD;;AAYA,MAAMM,SAAS,GAAG,CAChBC,KADgB,EAEhBC,UAFgB,EAGhBP,OAHgB,EAIhBC,MAJgB,KAKb;AACH,QAAMO,OAAO,GAAG,mBAAQF,KAAR,CAAhB;AACA,QAAMG,MAAM,GAAG,2BAAkBD,OAAlB,CAAf;AACA,QAAME,OAAO,GAAG,uBAAS,KAAT,EAAgB;AAC9BC,IAAAA,IAAI,EAAE;AAAEC,MAAAA,KAAK,EAAE;AAAT;AADwB,GAAhB,CAAhB;AAIAF,EAAAA,OAAO,CAACG,IAAR,CAAaJ,MAAb;AAEAC,EAAAA,OAAO,CAACI,SAAR,CAAkBP,UAAlB,EAA8B,KAA9B;AACAG,EAAAA,OAAO,CAACK,QAAR;AAEAd,EAAAA,MAAM,CAACG,GAAP,CAAW,yBAAX,EAAsCI,OAAtC;AACD,CAlBD;;AAoBA,MAAMQ,OAAO,GAAG,CACd;AAAEjB,EAAAA,YAAF;AAAgBQ,EAAAA,UAAhB;AAA4BD,EAAAA;AAA5B,CADc,EAEd;AAAEW,EAAAA,WAAF;AAAehB,EAAAA;AAAf,CAFc,KAGX;AACH,MAAI,CAACK,KAAL,EAAY;AACV,UAAM,IAAIY,cAAJ,CACJ,6FADI,EAEJ,UAFI,CAAN;AAID;;AAED,QAAMlB,OAAO,GAAGiB,WAAW,CAACjB,OAA5B;AAEA,QAAMmB,oBAAoB,GAAGZ,UAAU,IAAI,MAA3C;AAEAT,EAAAA,eAAe,CACbC,YAAY,IAAK,GAAEoB,oBAAqB,gBAD3B,EAEbnB,OAFa,EAGbC,MAHa,CAAf;AAKAI,EAAAA,SAAS,CAACC,KAAD,EAAQa,oBAAR,EAA8BnB,OAA9B,EAAuCC,MAAvC,CAAT;AACD,CArBD;;eAuBee,O","sourcesContent":["import SemanticReleaseError from '@semantic-release/error'\r\nimport archiver from 'archiver'\r\nimport { readJsonSync, writeJsonSync } from 'fs-extra'\r\n\r\nimport { createWriteStream } from 'fs'\r\nimport { resolve } from 'path'\r\n\r\nimport Context, { Logger } from './@types/context'\r\nimport PluginConfig from './@types/pluginConfig'\r\n\r\nconst prepareManifest = (\r\n  manifestPath: string,\r\n  version: string,\r\n  logger: Logger,\r\n) => {\r\n  const manifest = readJsonSync(manifestPath)\r\n\r\n  writeJsonSync(manifestPath, { ...manifest, version }, { spaces: 2 })\r\n\r\n  logger.log('Wrote version %s to %s', version, manifestPath)\r\n}\r\n\r\nconst zipFolder = (\r\n  asset: string,\r\n  distFolder: string,\r\n  version: string,\r\n  logger: Logger,\r\n) => {\r\n  const zipPath = resolve(asset)\r\n  const output = createWriteStream(zipPath)\r\n  const archive = archiver('zip', {\r\n    zlib: { level: 9 },\r\n  })\r\n\r\n  archive.pipe(output)\r\n\r\n  archive.directory(distFolder, false)\r\n  archive.finalize()\r\n\r\n  logger.log('Wrote zipped file to %s', zipPath)\r\n}\r\n\r\nconst prepare = (\r\n  { manifestPath, distFolder, asset }: PluginConfig,\r\n  { nextRelease, logger }: Context,\r\n) => {\r\n  if (!asset) {\r\n    throw new SemanticReleaseError(\r\n      \"Option 'asset' was not included in the prepare config. Check the README.md for config info.\",\r\n      'ENOASSET',\r\n    )\r\n  }\r\n\r\n  const version = nextRelease.version\r\n\r\n  const normalizedDistFolder = distFolder || 'dist'\r\n\r\n  prepareManifest(\r\n    manifestPath || `${normalizedDistFolder}/manifest.json`,\r\n    version,\r\n    logger,\r\n  )\r\n  zipFolder(asset, normalizedDistFolder, version, logger)\r\n}\r\n\r\nexport default prepare\r\n"],"file":"prepare.js"}